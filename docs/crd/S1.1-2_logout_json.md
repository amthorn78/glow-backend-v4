# CRD: S1.1-2 Logout JSON & Loop Check

**Date:** September 16, 2025  
**Goal:** Standardize logout response JSON and verify no redirect loops  
**Scope:** ~40 LOC in 1 file (app.py)

## Implementation Summary

Updated `/api/auth/logout` endpoint to return consistent JSON schema regardless of session state, ensuring idempotent behavior and eliminating redirect possibilities.

## Code Changes

### Modified `auth_v2_logout()` (app.py:2369-2416)

**Before:** Simple `{'ok': True}` response
**After:** Standardized JSON contract with session state awareness

```python
# Detect session state
user_id = session.get('user_id')
has_active_session = user_id is not None

# Standardized response for active session
if has_active_session:
    response_data = {
        'status': 'ok',
        'code': 'LOGOUT', 
        'message': 'Logged out',
        'idempotent': True,
        'ok': True
    }

# Standardized response for no session
else:
    response_data = {
        'status': 'ok',
        'code': 'LOGOUT',
        'message': 'No active session', 
        'idempotent': True,
        'ok': True
    }
```

**Error Response (500 cases):**
```python
{
    'status': 'error',
    'code': 'INTERNAL_ERROR',
    'message': 'Logout failed',
    'idempotent': False,
    'ok': False
}
```

## JSON Contract

| Field | Type | Description |
|-------|------|-------------|
| `status` | string | "ok" for success, "error" for failures |
| `code` | string | "LOGOUT" for success, error code for failures |
| `message` | string | Human-readable status message |
| `idempotent` | boolean | true for successful logout (safe to retry) |
| `ok` | boolean | true for success, false for errors |

## Behavior Changes

| Scenario | Before | After |
|----------|--------|-------|
| Active session logout | `{'ok': True}` | Full JSON contract with "Logged out" |
| No session logout | `{'ok': True}` | Full JSON contract with "No active session" |
| Error cases | Various formats | Consistent error JSON contract |
| Status codes | 200/500 | 200/500 (unchanged) |

## Manual Testing

```bash
# 1. Test with active session
curl -c cookies.txt -X POST /api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'

curl -i -b cookies.txt -X POST /api/auth/logout \
  -H "X-CSRF-Token: $(curl -s -b cookies.txt /api/auth/csrf | jq -r .token)"

# Expected: 200 + {"status":"ok","code":"LOGOUT","message":"Logged out","idempotent":true,"ok":true}

# 2. Test without session
curl -i -X POST /api/auth/logout \
  -H "Content-Type: application/json"

# Expected: 200 + {"status":"ok","code":"LOGOUT","message":"No active session","idempotent":true,"ok":true}

# 3. Verify no redirect loops
curl -i -b cookies.txt /api/auth/me
# Expected: 401 with typed JSON (no redirects)
```

## Redirect Loop Verification

**No Code Changes Needed:** Current implementation already returns JSON-only responses with no redirect headers.

**Verification Points:**
- `/api/auth/logout` returns JSON with 200 status (never redirects)
- `/api/auth/me` after logout returns 401 JSON (never redirects)  
- Frontend flows remain unaffected (no server-side redirects)

## Risk Assessment

- **Low Risk:** Endpoint exists, only response format changed
- **Backward Compatible:** All responses remain 200 for success
- **No Breaking Changes:** Frontend can handle additional JSON fields

## Rollback Plan

Single-commit revert to restore previous `{'ok': True}` response format.

## Files Modified

- `app.py`: Updated logout endpoint response format (~40 LOC)

## Acceptance Criteria

✅ **Active session logout:** Returns 200 + standardized JSON with "Logged out"  
✅ **No session logout:** Returns 200 + standardized JSON with "No active session"  
✅ **Idempotent behavior:** Same response for repeated calls  
✅ **No redirects:** JSON responses only, no redirect headers  
✅ **Security preserved:** Cache-Control and security headers maintained

