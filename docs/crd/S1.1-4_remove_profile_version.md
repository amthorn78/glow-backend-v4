# CRD: S1.1-4 Remove profile_version

**Date:** September 17, 2025  
**Goal:** Drop unused profile_version from DB/ORM and API to simplify contract  
**Scope:** 3 files, ~60 LOC (migration + model + serializer cleanup)

## Implementation Summary

Removed the deprecated `profile_version` field from the User model and `/api/auth/me` API response. The field was unused and added unnecessary complexity to the contract.

## Code Changes

### 1. Database Migration: `remove_profile_version_migration.py` (new file, ~80 LOC)

**Migration Logic:**
```python
# PostgreSQL: ALTER TABLE users DROP COLUMN profile_version
# SQLite: Column ignored in ORM (SQLite doesn't support DROP COLUMN)
```

**Safety Features:**
- Idempotent: checks if column exists before attempting to drop
- Database-aware: handles both PostgreSQL (production) and SQLite (dev)
- Error handling with rollback on failure
- Verification step to confirm column removal

### 2. User Model: `app.py` (1 line removed)

**Before:**
```python
class User(db.Model):
    # ... other fields ...
    profile_version = db.Column(db.Integer, nullable=False, default=1)  # Client hint/cache key
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

**After:**
```python
class User(db.Model):
    # ... other fields ...
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
```

### 3. API Serializer: `/api/auth/me` endpoint (5 changes)

**Removed from query select:**
```python
# Before: User.profile_version,
# After: (removed)
```

**Removed from result unpacking:**
```python
# Before: (user_id, email, status, is_admin, updated_at, profile_version, ...)
# After: (user_id, email, status, is_admin, updated_at, ...)
```

**Removed from response JSON:**
```python
# Before: 'profile_version': profile_version or 1,
# After: (removed)
```

**Removed from error handling and logging**

## API Contract Change

### Before:
```json
{
  "ok": true,
  "user": {
    "id": 2,
    "email": "admin@glow.app",
    "profile_version": 1,
    "..."
  }
}
```

### After:
```json
{
  "ok": true,
  "user": {
    "id": 2,
    "email": "admin@glow.app",
    "..."
  }
}
```

**Key Change:** `profile_version` field completely removed from response

## Testing Plan

**Database Migration:**
```bash
cd glow-backend-v4
python3 remove_profile_version_migration.py
# Expected: "Migration completed successfully"
```

**API Contract Verification:**
```bash
# Login and check /api/auth/me response
curl -sS -b cookies.jar "https://glowme.io/api/auth/me" | grep -v "profile_version"
# Expected: No profile_version key in response

# Verify key doesn't exist (requires jq or manual inspection)
# Expected: profile_version key absent from JSON
```

**Regression Testing:**
- Birth data save/read flows remain unchanged
- User authentication flows unaffected
- No server errors in auth/me path

## Risk Assessment

- **Low Risk:** Field removal only, no functional changes
- **Narrow Blast Radius:** Only affects `/api/auth/me` response shape
- **No Breaking Changes:** Field was unused by frontend
- **Reversible:** Can re-add field with default value if needed

## Rollback Plan

1. **Immediate:** Revert single commit to restore field in ORM
2. **Database:** Re-add column with default value:
   ```sql
   ALTER TABLE users ADD COLUMN profile_version INTEGER DEFAULT 1 NOT NULL;
   ```

## Files Modified

- `remove_profile_version_migration.py` (new file, 80 LOC)
- `app.py` (6 lines removed from User model and /api/auth/me)
- `docs/crd/S1.1-4_remove_profile_version.md` (documentation)

## Acceptance Criteria

✅ **Migration applies cleanly:** Column dropped in PostgreSQL, ignored in SQLite  
✅ **API contract updated:** `/api/auth/me` response contains no `profile_version` key  
✅ **Syntax validation:** Python compilation successful  
✅ **No regressions:** Auth flows remain functional

