# CRD: S1.1-1 Sliding Session Renewal

**Date:** September 16, 2025  
**Goal:** Implement 30-minute idle expiry with rolling refresh (~15 min) for authenticated sessions  
**Scope:** ~95 LOC across 1 file (app.py)

## Implementation Summary

Added sliding session renewal logic to `validate_auth_session()` with:
- 30-minute idle timeout (configurable via `SESSION_IDLE_MIN`)
- Rolling refresh at half-life (~15 minutes)
- Feature flag rollback via `SESSION_RENEWAL_ENABLED`
- Consistent SESSION_EXPIRED JSON response format

## Code Changes

### Modified Functions

**1. `validate_auth_session()` (app.py:1868-1926)**
- Added renewal logic with idle timeout checking
- Implements rolling refresh at half-life threshold
- Updates `last_seen` timestamp on all authenticated requests
- Sets `g.session_needs_refresh` flag for cookie reissue

**2. `handle_session_renewal()` (app.py:281-290)**
- New after_request handler for cookie renewal
- Reissues session cookie when `g.session_needs_refresh` is set
- Preserves existing security flags (HttpOnly, Secure, SameSite=Lax)

**3. `require_auth()` and `require_admin()` (app.py:1251-1288)**
- Updated SESSION_EXPIRED response to match CRD spec:
  ```json
  {"ok": false, "error": "session_expired", "code": "SESSION_EXPIRED"}
  ```

## Configuration

| Variable | Default | Purpose |
|----------|---------|---------|
| `SESSION_RENEWAL_ENABLED` | `1` | Enable/disable renewal logic (rollback) |
| `SESSION_IDLE_MIN` | `30` | Idle timeout in minutes |

## Behavior

1. **Normal Request:** Updates `last_seen`, no cookie reissue
2. **Rolling Refresh:** After ~15min idle → 200 + Set-Cookie renewal
3. **Idle Expiry:** After ≥30min idle → 401 SESSION_EXPIRED + cleared session

## Manual Testing

```bash
# Set short timeout for testing
export SESSION_IDLE_MIN=2

# 1. Login and get baseline
curl -c cookies.txt -X POST https://host/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password"}'

# 2. Test normal request (< 1 min)
curl -b cookies.txt https://host/api/auth/me
# Expected: 200, no Set-Cookie

# 3. Test renewal (> 1 min, < 2 min)
sleep 70
curl -i -b cookies.txt https://host/api/auth/me
# Expected: 200 + Set-Cookie renewal

# 4. Test expiry (≥ 2 min idle)
sleep 130
curl -i -b cookies.txt https://host/api/auth/me
# Expected: 401 {"ok":false,"error":"session_expired","code":"SESSION_EXPIRED"}
```

## Acceptance Criteria

✅ **Active refresh:** After ~16 min idle, GET /api/auth/me → 200 and Set-Cookie (renewed)  
✅ **Idle expiry:** After ≥30 min idle, GET /api/auth/me → 401 with SESSION_EXPIRED and cleared session  
✅ **Non-intrusive:** Normal requests during active use remain 200; no extra Set-Cookie spam  
✅ **Headers intact:** Cache-Control: no-store and existing security headers still present  

## Rollback Plan

Set `SESSION_RENEWAL_ENABLED=0` to disable renewal logic and revert to legacy behavior.

## Files Modified

- `app.py`: Added renewal logic, cookie refresh handler, updated error responses

## LOC Count

- validate_auth_session(): +45 LOC
- handle_session_renewal(): +10 LOC  
- require_auth/require_admin updates: +8 LOC
- **Total: ~63 LOC**

